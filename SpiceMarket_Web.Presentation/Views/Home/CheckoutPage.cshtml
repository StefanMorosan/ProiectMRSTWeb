using Microsoft.AspNetCore.Mvc;
using SpiceMarket_Web.Domain.Models;
using System.Collections.Generic;
using System.Linq;

namespace SpiceMarket_Web.Presentation.Controllers
{
    public class HomeController : Controller
    {
        private readonly ApplicationDbContext _context;

        public HomeController(ApplicationDbContext context)
        {
            _context = context;
        }

        // Checkout action to display the checkout page
        public IActionResult Checkout()
        {
            // Get the cart items from session or TempData
            var cartItems = TempData["Cart"] as List<CartItem>
    ;

    if (cartItems == null || cartItems.Count == 0)
    {
    TempData["Error"] = "Coșul tău este gol. Adaugă produse înainte de checkout.";
    return RedirectToAction("Cos");
    }

    return View(cartItems); // Pass cart items to the checkout page
    }

    // PlaceOrder action to handle order submission
    [HttpPost]
    public IActionResult PlaceOrder()
    {
    var cartItems = TempData["Cart"] as List<CartItem>
        ;

        if (cartItems == null || cartItems.Count == 0)
        {
        TempData["Error"] = "Coșul tău este gol. Adaugă produse înainte de checkout.";
        return RedirectToAction("Cos");
        }

        // Save purchase details to the database
        foreach (var item in cartItems)
        {
        var purchase = new Purchase
        {
        ProdusId = item.ProdusId, // Assuming CartItem has ProdusId
        CustomerId = 123, // Example customer ID
        Quantity = item.Cantitate,
        PurchaseDate = DateTime.Now
        };

        _context.Purchases.Add(purchase);
        }

        _context.SaveChanges();
        TempData["Success"] = "Comanda a fost plasată cu succes!";
        return RedirectToAction("Cos");
        }
        }
        }
